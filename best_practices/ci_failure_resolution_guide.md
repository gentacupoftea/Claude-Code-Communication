# CI/CD 障害対応ガイド

## 1. はじめに
このドキュメントは、CI/CDパイプラインで障害（例: テストの失敗、ビルドエラー）が発生した際の、体系的な原因特定と解決のための手順を定めたガイドです。

## 2. 基本原則
- **慌てず、冷静に**: CIの失敗は開発プロセスの一部です。焦らず、手順に従って対応します。
- **情報収集を最優先**: 推測で修正する前に、ログや差分から原因を特定します。
- **影響範囲の確認**: 他のブランチや開発者に影響が及んでいないか確認します。
- **記録と共有**: 原因と対策を記録し、チームで共有することで、将来の同様の問題を未然に防ぎます。

## 3. 障害対応フロー
CIの障害発生時は、以下のステップに従って対応します。

### ステップ1: 状況把握 (最初の5分)
1.  **[ ] CIの失敗通知を確認する**:
    - どのプルリクエスト(PR)やブランチで発生したか？
    - どのジョブ（テスト、ビルド、デプロイなど）で失敗したか？
2.  **[ ] CIのログ出力を確認する**:
    - エラーメッセージが出力されている箇所を特定します。
    - `error`, `failed`, `exception` などのキーワードでログを検索します。
3.  **[ ] コードの変更差分を確認する**:
    - 失敗の原因となった可能性のある直近のコミットやPRの変更内容を確認します。
    - 特に、設定ファイル、依存関係、共通ライブラリの変更に注意します。

### ステップ2: 原因の切り分けと特定 (5分～30分)
収集した情報をもとに、一般的な原因を切り分けます。

#### [ ] A. テストの失敗
- **原因の可能性**:
  - コードの変更によるリグレッション（意図しない副作用）
  - テストコード自体のバグ
  - テスト環境の不安定さ（例: 外部APIへの接続失敗）
  - スナップショットテストの不一致
- **特定方法**:
  - 失敗したテストをローカル環境で再現させます。
  - デバッガを使用して、失敗箇所をステップ実行します。
  - エラーメッセージを元に、関連するコードとテストを読み解きます。

#### [ ] B. 依存関係のエラー
- **原因の可能性**:
  - `package.json` や `requirements.txt` の記述ミス
  - 新しく追加したライブラリと既存ライブラリの競合
  - CI環境のキャッシュの問題
  - ライブラリのバージョンアップによる破壊的変更
- **特定方法**:
  - ローカルで依存関係を再インストール (`rm -rf node_modules && npm install`) して、問題が再現するか確認します。
  - CIのログで、`npm install` や `pip install` のエラーメッセージを確認します。
  - 必要であれば、CIのキャッシュをクリアして再実行します。

#### [ ] C. ビルドの失敗
- **原因の可能性**:
  - TypeScriptなどの型エラー
  - ESLintなどの静的解析エラー
  - ビルドスクリプト自体の問題
  - 環境変数の設定ミス
- **特定方法**:
  - ビルドコマンド (`npm run build` など) をローカルで実行し、エラーが再現するか確認します。
  - エラーメッセージで指摘されているファイルと行番号を確認し、修正します。

#### [ ] D. 環境の問題
- **原因の可能性**:
  - CIランナーのリソース不足 (メモリ、ディスク)
  - 外部サービス（DB、APIなど）への接続障害
  - シークレットやAPIキーの設定ミス
- **特定方法**:
  - CIのログで、リソース不足やタイムアウトに関するエラーがないか確認します。
  - 外部サービスのステータスページを確認します。
  - CIの再実行（Re-run）で解決するか試します。（一時的なネットワーク問題の場合など）

### ステップ3: 修正と検証
1.  **[ ] ローカルでの修正**:
    - 特定した原因に基づき、コードや設定を修正します。
    - ローカルでテストやビルドが成功することを確認します。
2.  **[ ] 修正のプッシュ**:
    - 修正内容をコミットし、PRにプッシュします。
3.  **[ ] CIでの検証**:
    - 再度実行されたCIが、今度は成功（Green）することを確認します。
4.  **[ ] レビューとマージ**:
    - 修正内容について、チームメンバーにレビューを依頼します。

## 4. 予防策
- **CIの高速化**: フィードバックループを短くし、問題の早期発見を促します。
- **セレクティブテスト**: 変更に関連するテストのみを実行し、時間を短縮します。
- **依存関係のロック**: `package-lock.json` や `poetry.lock` を活用し、環境の再現性を担保します。
- **定期的なライブラリ更新**: `dependabot`などを活用し、ライブラリを常に最新の状態に保ち、大きなバージョンアップによる問題を避けます。 