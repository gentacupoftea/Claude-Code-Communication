name: Claude Code
on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    claude:
        if: github.event.issue.pull_request && contains(github.event.comment.body, '@claude')
        runs-on: ubuntu-latest
        permissions:
            contents: 'write'
            pull-requests: 'write'
            issues: 'write'
            id-token: 'write'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: 'Authenticate to Google Cloud'
              uses: 'google-github-actions/auth@v2'
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: 'Run Claude Code via Vertex AI'
              id: claude
              uses: Akira-Papa/claude-code-base-action@main
              with:
                  use_vertex: "true"
                  model: "claude-3-sonnet@20240229"
                  github_token: ${{ secrets.GENTA_PAT || secrets.GITHUB_TOKEN }}
                  pr_number: ${{ github.event.issue.number }}
                  prompt: "The user triggered this review with the following comment: ${{ github.event.comment.body }}"
                  system_prompt_file: 'docs/prompts/project_guidelines/comprehensive_development_guidelines.md'

