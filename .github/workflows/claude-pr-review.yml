name: 'Claude PR Reviewer'

on:
  issue_comment:
    types: [created]

jobs:
  review:
    # コメントがPRに対するもので、かつ内容に「@claude」が含まれている場合のみジョブを実行
    if: github.event.issue.pull_request && contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4
        with:
          # PRのブランチをチェックアウトする
          ref: ${{ github.event.issue.pull_request.head.ref }}
          # 履歴をすべて取得して差分比較を可能にする
          fetch-depth: 0 

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 'Claude Review Action'
        uses: zbeekman/claude-pr-review-action@v1
        env:
          # 既存のアクセストークンを、Actionが要求するAPIキーとして渡す
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
        with:
          # GitHubコンテキストからPR番号を自動で取得
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # レビューの指針となるガイドラインファイルのパス
          PROMPT_FILE_PATH: 'docs/prompts/project_guidelines/comprehensive_development_guidelines.md'
          # レビュー対象のファイル拡張子を指定
          INCLUDE_GLOBS: |
            src/**/*.{ts,tsx,js,jsx}
            *.{js,ts,json}