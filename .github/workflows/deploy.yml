name: ğŸš€ Auto Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  CACHE_NAME: 'node-modules-v1'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend-v2/package-lock.json

      - name: ğŸ“¦ Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            frontend-v2/node_modules
            ~/.npm
          key: ${{ env.CACHE_NAME }}-${{ runner.os }}-node-${{ hashFiles('frontend-v2/package-lock.json') }}
          restore-keys: |
            ${{ env.CACHE_NAME }}-${{ runner.os }}-node-

      - name: ğŸ“¦ Install dependencies
        working-directory: frontend-v2
        run: |
          # é«˜é€Ÿã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
          npm ci --prefer-offline --no-audit --no-fund
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ” Security audit
        working-directory: frontend-v2
        run: |
          npm audit --omit=dev --audit-level=high
          echo "âœ… Security audit completed"

      - name: ğŸ¨ Lint code
        working-directory: frontend-v2
        run: |
          npm run lint
          echo "âœ… Linting completed"

      - name: ğŸ” Type check
        working-directory: frontend-v2
        run: |
          npx tsc --noEmit --incremental
          echo "âœ… Type checking completed"

      - name: ğŸ—ï¸ Build project
        working-directory: frontend-v2
        run: |
          echo "ğŸ”¨ Starting build process..."
          npm run build
          echo "âœ… Build completed successfully"
          echo "ğŸ“Š Build output size:"
          du -sh out
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL || 'https://api.staging.conea.ai' }}
          # æœ€é©åŒ–è¨­å®š
          NEXT_TELEMETRY_DISABLED: 1
          CI: true

      - name: ğŸ“‹ Build artifacts summary
        working-directory: frontend-v2
        run: |
          echo "ğŸ“Š Build Summary:"
          echo "==================="
          if [ -d "out" ]; then
            echo "ğŸ“ Total files: $(find out -type f | wc -l)"
            echo "ğŸ“¦ Total size: $(du -sh out | cut -f1)"
            echo "ğŸ—‚ï¸ File breakdown:"
            find out -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          else
            echo "âŒ Build output directory not found"
            exit 1
          fi

      - name: ğŸš€ Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CONEA_48FCF }}
          projectId: conea-48fcf
          channelId: live
          entryPoint: frontend-v2
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

      - name: ğŸ‰ Deployment success
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Site URL: https://stagingapp.conea.ai"
          echo "ğŸ“Š Deployment time: $(date)"

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ“‹ Common issues:"
          echo "  - Firebase service account configuration"
          echo "  - Build artifacts missing"
          echo "  - Environment variables not set"