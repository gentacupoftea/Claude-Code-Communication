name: PR Quality Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

# PRå°‚ç”¨ã®è»½é‡ãƒã‚§ãƒƒã‚¯ - é«˜é€Ÿãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«é‡ç‚¹ã‚’ç½®ã
env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  quick-checks:
    name: Quick Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # æµ…ã„ã‚¯ãƒ­ãƒ¼ãƒ³ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Š
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install and lint (parallel)
        run: |
          # ä¸¦åˆ—å®Ÿè¡Œã§ãƒªãƒ³ãƒˆå‡¦ç†ã‚’é«˜é€ŸåŒ–
          (cd frontend-v2 && npm ci && npm run lint) &
          (cd backend && npm ci && npm run lint) &
          (pip install flake8 mypy && flake8 src/ --max-line-length=127 --statistics) &
          wait
        timeout-minutes: 10
      
      - name: TypeScript type checking
        run: |
          cd frontend-v2 && npx tsc --noEmit
      
      - name: Security quick scan
        run: |
          # è»½é‡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆåŸºæœ¬çš„ãªå•é¡Œã®ã¿ï¼‰
          npm audit --audit-level=high --summary || true
          pip install safety && safety check --short-report || true
        continue-on-error: true
      
      - name: Build test (smoke test)
        run: |
          # ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ•ãƒ«ãƒ“ãƒ«ãƒ‰ã¯é¿ã‘ã‚‹ï¼‰
          cd frontend-v2 && npm run build --silent
        timeout-minutes: 5

  changed-files-analysis:
    name: Changed Files Impact Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files_yaml: |
            frontend:
              - frontend-v2/**
            backend:
              - backend/**
            multillm:
              - multiLLM_system/**
            workflows:
              - .github/workflows/**
            docs:
              - docs/**
              - '**.md'
      
      - name: Generate impact summary
        run: |
          echo "## ðŸ“Š PR Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]; then
            echo "ðŸŽ¨ **Frontend changes detected** - Frontend CI will run" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]; then
            echo "âš™ï¸ **Backend changes detected** - Backend CI will run" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changed-files.outputs.multillm_any_changed }}" == "true" ]; then
            echo "ðŸ¤– **MultiLLM changes detected** - MultiLLM CI will run" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changed-files.outputs.workflows_any_changed }}" == "true" ]; then
            echo "ðŸ”§ **Workflow changes detected** - Review required" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]; then
            echo "ðŸ“š **Documentation changes detected**" >> $GITHUB_STEP_SUMMARY
          fi