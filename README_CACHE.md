# キャッシュシステム ドキュメント

本ドキュメントは、Shopify MCP Serverのキャッシュシステムの実装と使用方法について説明します。

## 概要

キャッシュシステムは、API呼び出しや計算結果を一時的に保存することで、アプリケーションのパフォーマンスを向上させます。主な機能は以下の通りです：

1. **LRUキャッシュアルゴリズム**
   - 最近使用されていないエントリを優先的に削除
   - 効率的なメモリ使用を実現

2. **メモリ管理**
   - キャッシュサイズの上限設定
   - メモリ使用量の監視
   - 上限到達時の自動エビクション（古いエントリの削除）

3. **パフォーマンス測定**
   - キャッシュヒット率・ミス率の計測
   - メモリ使用量のモニタリング
   - 処理時間の比較

4. **スレッドセーフ実装**
   - 複数スレッドからの安全なアクセス
   - 競合状態の回避

## 設定

キャッシュは以下の環境変数で設定できます：

| 環境変数 | 説明 | デフォルト |
|----------|------|------------|
| CACHE_TTL | キャッシュエントリの有効期間（秒） | 300 |
| CACHE_MAX_SIZE | キャッシュの最大エントリ数 | 1000 |
| CACHE_MAX_MEMORY_MB | キャッシュの最大メモリ使用量（MB） | 100 |
| CACHE_STRATEGY | キャッシュ戦略（"lru"または"ttl"） | "lru" |

`.env`ファイルに設定を追加する例：

```
# キャッシュ設定
CACHE_TTL=600
CACHE_MAX_SIZE=2000
CACHE_MAX_MEMORY_MB=200
CACHE_STRATEGY=lru
```

## 使用方法

### 基本的な使用方法

キャッシュは主に`@memoize`デコレータを通じて使用します：

```python
from utils import memoize

@memoize(ttl=300)  # 5分間キャッシュ
def expensive_function(param1, param2):
    # 時間のかかる処理
    return result
```

### 直接キャッシュを操作

`cache_manager`を直接使用することもできます：

```python
from utils import cache_manager

# キャッシュに値を設定
cache_manager.set("my_key", my_value)

# キャッシュから値を取得
value = cache_manager.get("my_key")

# キャッシュをクリア
cache_manager.clear()

# 特定の関数のキャッシュをクリア
cache_manager.clear_for_function("function_name")
```

### キャッシュ統計の取得

キャッシュのパフォーマンス統計を取得できます：

```python
from utils import cache_manager

stats = cache_manager.get_stats()
print(f"ヒット率: {stats.hit_rate:.2%}")
print(f"メモリ使用量: {stats.memory_usage_mb:.2f} MB")
print(f"エントリ数: {stats.entry_count}")
```

## 実装詳細

### LRUアルゴリズム

Least Recently Used（最近最も使われていない）アルゴリズムは、`collections.OrderedDict`を使用して実装されています。キャッシュエントリにアクセスするたびに、そのエントリはOrderedDictの末尾に移動します。キャッシュが一杯になると、OrderedDictの先頭（最も長く使われていないエントリ）が削除されます。

### メモリ管理

キャッシュは以下の2つの制限に基づいてエントリを削除します：

1. **エントリ数の制限**: `CACHE_MAX_SIZE`で設定
2. **メモリ使用量の制限**: `CACHE_MAX_MEMORY_MB`で設定

どちらかの制限に達すると、LRUアルゴリズムに基づいてエントリが削除されます。

### スレッドセーフティ

`threading.Lock`を使用して、複数スレッドからの同時アクセスを安全に処理します。すべてのキャッシュ操作（get, set, clear）はロックで保護されています。

### パフォーマンス測定

キャッシュは以下のメトリクスを追跡します：

- **ヒット数**: キャッシュから正常に取得された回数
- **ミス数**: キャッシュに存在しなかった回数
- **ヒット率**: ヒット数 / (ヒット数 + ミス数)
- **メモリ使用量**: キャッシュが使用しているメモリ量
- **エントリ数**: キャッシュ内のエントリ数
- **エビクション数**: 制限により削除されたエントリ数

## パフォーマンス最適化のヒント

1. **適切なTTL設定**
   - データの更新頻度に合わせてTTLを設定
   - 頻繁に変更されるデータには短いTTL
   - 静的なデータには長いTTL

2. **メモリ制限の調整**
   - アプリケーションの利用可能なメモリに合わせて設定
   - 大きなオブジェクトをキャッシュする場合は制限を大きく

3. **キャッシュ戦略の選択**
   - アクセスパターンが偏っている場合は"lru"が効果的
   - 時間ベースの有効期限が重要な場合は"ttl"を使用

## テスト

キャッシュのパフォーマンスをテストするには：

```bash
python test_cache_performance.py
```

このテストは以下を検証します：
- キャッシュによる高速化の効果
- メモリ制限とエビクションの動作
- LRUアルゴリズムの正確性
- スレッドセーフティ

## 将来の拡張

1. **分散キャッシュ対応**
   - Redisなどの外部キャッシュシステムとの統合

2. **キャッシュプリウォーミング**
   - 起動時に頻繁に使用されるデータを事前にキャッシュ

3. **キャッシュイベントフック**
   - エビクションや有効期限切れ時のカスタムアクション
