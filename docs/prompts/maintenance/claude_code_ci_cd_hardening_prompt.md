# 【最重要】CI/CD品質ゲート強化によるmainブランチ防衛作戦

## 背景と目的

げんたさん、我々のプロジェクトは今、大きな岐路に立たされています。

先日、`main`ブランチに大量のESLintエラーを含むコードがマージされ、ビルドもリントも通らないという危機的状況に陥りました。これは、現在のCI/CDプロセスに、コード品質を保証するための「強制力」が欠如していることを明確に示しています。

あなたのミッションは、**GitHub Actionsと関連スクリプトを改修し、品質基準を満たさないコードがPRの段階で確実にブロックされる、鉄壁の防衛ラインを構築すること**です。もはや、人間の注意力や手動チェックに頼る段階は終わりました。システムで、機械的に、絶対に防ぎます。

## 遂行すべきタスク

### 1. `package.json` に "門番" スクリプトを定義する

現在、`lint`, `build`, `test`が個別のスクリプトとして存在します。これらをCI上で個別に実行すると、どれか一つが漏れたり、設定が複雑になったりする可能性があります。

そこで、これら全てを一度に実行する統合スクリプトを`package.json`の`scripts`セクションに新しく定義してください。

-   **スクリプト名:** `validate`
-   **処理内容:** `npm run typecheck`, `npm run lint`, `npm run build`, `npm run test:e2e:smoke` をこの順番で連続して実行する。一つでも失敗したら、スクリプト全体が失敗するようにしてください。（`&&`で繋ぐのが良いでしょう）
    -   `test`ではなく`test:e2e:smoke`を使うことで、CIの時間を短縮しつつ、主要な機能が壊れていないことを確認します。

### 2. GitHub Actions ワークフロー (`pr-validation.yml`) の単純化と強化

ステップ1で作成した`validate`スクリプトを使い、`.github/workflows/pr-validation.yml`を全面的に強化・単純化してください。

-   **トリガー設定の確認:** `main`ブランチをターゲットとする全てのプルリクエストで発火するように設定されているか、改めて確認してください。
-   **ジョブの簡素化:** 既存の`lint`, `build`, `test`などの個別ステップを廃止し、代わりに `npm run validate` を実行する単一のステップに置き換えてください。これにより、ワークフローの見通しが良くなり、管理が容易になります。

### 3. GitHub ブランチ保護ルールの設定指示（最重要）

ここがこの作戦の核心です。ワークフローが成功しても、それが「必須」でなければマージできてしまいます。

以下の内容で、`main`ブランチの保護ルールを設定するよう、私（げんたさん）に明確な手順を指示してください。

-   **必須ステータスチェックの有効化:**
    -   ブランチ保護ルールの設定画面を開く手順。
    -   `pr-validation.yml`のジョブ名（例: `build-and-test`など）を、**必須ステータスチェック (Require status checks to pass before merging)** として設定する方法。
-   **管理者も例外としない:**
    -   `管理者を含める (Include administrators)` オプションを有効にすることを強く推奨してください。これにより、誰もこの品質ゲートを迂回できなくなります。
-   **最新の状態を要求:**
    -   `マージする前にブランチを最新にする必要がある (Require branches to be up to date before merging)` も有効にすることを推奨してください。

## 最終的な成果物

1.  **修正済みの `package.json` ファイル**
2.  **修正済みの `.github/workflows/pr-validation.yml` ファイル**
3.  **GitHubのブランチ保護ルールを設定するための、げんたさん向けの分かりやすいステップ・バイ・ステップのガイド**

この防衛ラインが完成すれば、我々の`main`ブランチは常にビルド可能で、最低限の品質が保たれた状態になります。プロジェクトの未来は、このゲートキーパーの堅牢性にかかっています。

直ちに作戦を開始してください！ 