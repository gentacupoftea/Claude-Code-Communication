# プロジェクトルールファイル同期確認スクリプト定義プロンプト

このプロンプトは、`main` ブランチへのマージ操作やプッシュ操作の前に、プロジェクトの基本的なルールやプロンプト定義ファイル群が正しく同期されていることを確認するための手動スクリプトを定義・管理するためのものです。

## 目的と背景

- **主目的**: `main` ブランチへの変更を行う直前に、最新のプロジェクト関連ファイル群がローカルの `main` ブランチに正しくコミットされ、リモートと同期している状態を保証する
- **背景**: フィーチャーブランチの開発中にプロジェクトルールファイルが更新された場合、それが他の変更より先に `main` に反映されていることを確認する必要がある
- **対象**: プロジェクトの基本設定・ルール・プロンプト定義に関わるファイル群

## スクリプト定義テンプレート

以下のテンプレートに従って、プロジェクトルールファイル同期確認スクリプトの詳細を定義してください。

---

### スクリプト名: Ensure Project Rules Files are Synced to Main

#### 1. 基本情報
- **目的・概要**: `main` ブランチへのマージ操作やプッシュ操作の前に、プロジェクトの基本的なルールやプロンプト定義ファイル群が、ローカルの `main` ブランチで最新の状態にあり、かつコミット済みであることを確認する。未コミットの変更があればユーザーに通知し、適切な対応を促す。
- **実行タイミング**: mainブランチへのマージ前・プッシュ前（必須）
- **実行環境**: Gitコマンドが利用可能な環境
- **重要度**: 必須

#### 2. 対象ファイル・ディレクトリ
- `my-cursor-rule.mdc` - 統合プロジェクトルールファイル
- `docs/project_rules/` - プロジェクト基本ルール（ディレクトリ内全ファイル）
- `docs/prompts/` - 各種プロンプト定義（サブディレクトリ含む全ファイル）
- その他プロジェクト基本設定に関わるファイル（必要に応じて追加）

#### 3. 実行コマンド
```bash
#!/bin/bash
# プロジェクトルールファイル同期確認スクリプト

echo "=== プロジェクトルールファイル同期確認開始 ==="

# 1. 現在のブランチが main であることを確認
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    echo "❌ エラー: 現在のブランチが main ではありません (現在: $current_branch)"
    echo "   main ブランチに切り替えてから再実行してください"
    exit 1
fi

echo "✅ 現在のブランチ: main"

# 2. 対象ファイル・ディレクトリの変更状況確認
target_files="my-cursor-rule.mdc docs/project_rules/ docs/prompts/"
echo "🔍 対象ファイル・ディレクトリの変更状況確認中..."

# 未追跡ファイルと変更されたファイルの確認
untracked_files=$(git ls-files --others --exclude-standard $target_files 2>/dev/null)
modified_files=$(git diff --name-only $target_files 2>/dev/null)
staged_files=$(git diff --cached --name-only $target_files 2>/dev/null)

changes_detected=false

if [ -n "$untracked_files" ]; then
    echo "⚠️  未追跡のプロジェクトルールファイルが検出されました:"
    echo "$untracked_files" | sed 's/^/   - /'
    changes_detected=true
fi

if [ -n "$modified_files" ]; then
    echo "⚠️  変更されたプロジェクトルールファイルが検出されました:"
    echo "$modified_files" | sed 's/^/   - /'
    changes_detected=true
fi

if [ -n "$staged_files" ]; then
    echo "⚠️  ステージングされたプロジェクトルールファイルが検出されました:"
    echo "$staged_files" | sed 's/^/   - /'
    changes_detected=true
fi

# 3. 変更が検出された場合の処理
if [ "$changes_detected" = true ]; then
    echo ""
    echo "❌ プロジェクトルールファイルに未コミットの変更があります"
    echo ""
    echo "📋 対応手順:"
    echo "   1. 変更内容を確認してください: git status"
    echo "   2. 必要に応じてファイルをステージング: git add <ファイル名>"
    echo "   3. 変更をコミット: git commit -m \"feat(project): プロジェクトルール更新\""
    echo "   4. このスクリプトを再実行してください"
    echo ""
    exit 1
fi

# 4. リモートとの同期状況確認
echo "🔄 リモートとの同期状況確認中..."

# リモートの最新情報を取得
git fetch origin main --quiet

# ローカルとリモートの差分確認
local_commits=$(git rev-list --count origin/main..HEAD)
remote_commits=$(git rev-list --count HEAD..origin/main)

if [ "$remote_commits" -gt 0 ]; then
    echo "⚠️  リモートの main ブランチに新しいコミットがあります ($remote_commits 件)"
    echo "   git pull origin main を実行して最新化してください"
    exit 1
fi

if [ "$local_commits" -gt 0 ]; then
    echo "ℹ️  ローカルにコミット済みの変更があります ($local_commits 件)"
    echo "   必要に応じて git push origin main でリモートに反映してください"
fi

# 5. 成功時のメッセージ
echo ""
echo "✅ プロジェクトルールファイル同期確認完了"
echo "   - 対象ファイルに未コミットの変更はありません"
echo "   - リモートとの同期状況を確認済みです"
echo "   - main ブランチへの操作を安全に実行できます"
echo ""
```

#### 4. 期待される結果
- **成功時の出力**: 
  - 対象ファイルに未コミットの変更がない場合: 成功メッセージを表示して終了コード 0
  - ローカルとリモートの同期状況を表示
- **失敗時の挙動**: 
  - 未コミットの変更がある場合: 変更内容と対応手順を表示して終了コード 1
  - main ブランチでない場合: エラーメッセージを表示して終了コード 1
  - リモートとの差分がある場合: 同期を促すメッセージを表示して終了コード 1

#### 5. 主な処理ステップ
1. **ブランチ確認**: 現在のブランチが `main` であることを確認
2. **変更状況確認**: 対象ファイル・ディレクトリの未追跡・変更・ステージング状況をチェック
3. **変更検出時の処理**: 未コミットの変更があれば詳細な対応手順を表示
4. **リモート同期確認**: `git fetch` でリモートの最新情報を取得し、差分を確認
5. **結果報告**: 同期状況と実行可否を明確に表示

#### 6. 前提条件・依存関係
- **実行前に必要な環境**: 
  - Gitコマンドが利用可能
  - プロジェクトルートディレクトリで実行
  - リモートリポジトリ（origin）が設定済み
- **他のスクリプトとの依存関係**: 
  - 他のどのスクリプトよりも**最初**に実行すべき
  - このスクリプトが成功した場合のみ、他のマージ・プッシュ作業を実行
- **必要な権限**: Git操作権限、対象ディレクトリの読み取り権限

#### 7. トラブルシューティング
- **よくあるエラーとその対処法**:
  - `fatal: not a git repository`: プロジェクトルートで実行されていない → `cd` でプロジェクトルートに移動
  - `fatal: 'origin/main' does not exist`: リモートブランチが設定されていない → `git remote -v` で確認、必要に応じて設定
  - 権限エラー: 実行権限がない → `chmod +x script_name.sh` で実行権限を付与
- **デバッグ方法**: 
  - `bash -x script_name.sh` で詳細な実行ログを出力
  - `git status --porcelain` で変更状況の詳細確認
- **スキップ条件**: 
  - **このスクリプトはスキップ不可**（プロジェクトの整合性確保のため必須）

#### 8. 実行時間と性能
- **実行時間目安**: 5-15秒（リモート通信を含む）
- **大量ファイル時の考慮**: 対象ディレクトリが限定的なため、性能問題は発生しにくい
- **ネットワーク依存**: `git fetch` でリモート確認を行うため、ネットワーク接続が必要

#### 9. メタ情報
- **担当者**: プロジェクト管理者・Claude Code
- **最終更新日**: 2025-01-24
- **バージョン**: v2.0 (プロジェクトルールファイル特化版)
- **備考**: フィーチャーブランチ全体のチェックではなく、プロジェクトルール関連ファイルの同期に特化

---

## スクリプト実装例（保存先: `scripts/ensure_project_rules_sync.sh`）

上記定義に基づいて、実際にスクリプトファイルを作成する場合は、以下の場所に保存することを推奨します：

```bash
# スクリプト保存先
./scripts/ensure_project_rules_sync.sh

# 実行権限付与
chmod +x ./scripts/ensure_project_rules_sync.sh

# 実行方法
./scripts/ensure_project_rules_sync.sh
```

## 使用シーン

このスクリプトは以下のシーンで実行することを強く推奨します：

1. **フィーチャーブランチを main にマージする前**
2. **main ブランチに直接変更をプッシュする前**
3. **プロジェクトルールファイルを更新した後**
4. **リリース前の最終確認時**

## 継続的改善

- プロジェクトの成長に伴い、対象ファイル・ディレクトリを適宜追加
- 実行時間やエラーパターンの分析に基づく改善
- チーム運用の実態に合わせたメッセージやフローの調整

---

**更新履歴**
- **2025-01-24**: v2.0 - プロジェクトルールファイル同期に特化した定義に全面改訂
- **2025-01-24**: v1.0 - 初版作成（フィーチャーブランチ全体チェック版）